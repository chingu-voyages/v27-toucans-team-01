<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Spotify Playlist Manager</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <style type="text/css">
    .hidden {
      display: none;
    }

    
  </style>
</head>

<body>

  <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <span class="navbar-brand">Spotify Playlist Manager</span>
      </div>
    </div>
  </nav>

  <div class="container page-content">
    <div id="spotifyLoginView" class="hidden">
      <div class="jumbotron">
        <h1>Please login to Spotify to continue</h1>
        <p><a class="btn btn-lg btn-primary" href="spotifyLogin" role="button">Login</a></p>
      </div>
    </div>

    <div id="deezerLoginView" class="hidden">

      <h1>Please login to Deezer to continue</h1>
      <p><a class="btn btn-lg btn-primary" href="deezerLogin" role="button">Login</a></p>

    </div>

    <div id="artists"></div>

  </div>


  <script id="playlist-template" type="text/x-handlebars-template">
		<td>{{name}}</td>
		<td class="text-center">
			<button aria-label="Copy to Deezer" data-playlist-id="{{id}}" data-playlist-name="{{name}}">
				<span class="glyphicon glyphicon-export">
				</span>
			</button>
		</td>
    </script>

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
  <script>
    (function () {

      var params = getHashParams();

      var spotifyAccessToken = tryGetParam('spotify_access_token', params),
        spotifyRefreshToken = tryGetParam('spotify_refresh_token', params),
        spotifyUserId = tryGetParam('spotify_user_id', params),
        deezerAccessToken = tryGetParam('deezer_access_token', params),
        deezerUserId = tryGetParam('deezer_user_id', params),
        error = params.error;

      if (error) {
        alert(error);
        return;
      }

      if (spotifyAccessToken === null || spotifyUserId === null) {
        loginToSpotify();
      }
      else {
        loadTracks(spotifyUserId, spotifyAccessToken)
      }

      // From https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/endsWith
      if (!String.prototype.endsWith) {
        Object.defineProperty(String.prototype, 'endsWith', {
          value: function (searchString, position) {
            var subjectString = this.toString();
            if (position === undefined || position > subjectString.length) {
              position = subjectString.length;
            }
            position -= searchString.length;
            var lastIndex = subjectString.indexOf(searchString, position);
            return lastIndex !== -1 && lastIndex === position;
          }
        });
      }

      /**
      * Obtains parameters from the hash of the URL
      * @return Object
      */
      function getHashParams() {

        var hashParams = {};
        var e,
          r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      function tryGetParam(paramName, queryStringParams) {

        var value = queryStringParams[paramName];

        if (typeof value === "undefined" || value === '') {
          value = sessionStorage.getItem(paramName);
        }
        else {
          sessionStorage.setItem(paramName, value);
        }

        return value;
      }

      function loginToSpotify() {

        document.getElementById('spotifyLoginView').classList.remove('hidden');
      }

      function loginToDeezer() {

        document.getElementById('deezerLoginView').classList.remove('hidden');
      }

      function loadTracks(spotifyUserId, spotifyAccessToken) {



        var trackUrl = 'https://api.spotify.com/v1/me/top/' + encodeURIComponent(spotifyUserId) + '/tracks'
        sendSpotifyAjaxRequest('GET', trackUrl, displayTracks);
      }

      function displayTracks(trackResponse) {
        var trackSection = getElementById('artists').innerHTML

        console.log(trackResponse.items)

        trackResponse.items.map(function (trackResponse) {



          var list = "<div class='music-card'>" + "<img" + song.album.images[0] + ">" +
            "<p>" + song.name +
            "<p>" + song.artists[0].name + " - " + song.album.name + "</p>" +
            "<br><br>" + "</div";


          document.getElementById('artists').innerHTML += list;
        });
      }

  
      function sendSpotifyAjaxRequest(type, url, onSuccess) {
			
      return $.ajax({
        type: type,
        url: url,
        headers: {
          'Authorization': 'Bearer ' + spotifyAccessToken
        },
        success: onSuccess,
        error: ajaxError,
      });
    }
    
    function ajaxError(jqXHR, textStatus, errorThrown) {
      
      var ajaxError = {
        textStatus: textStatus,
        errorThrown: errorThrown,
      };
      console.error(ajaxError);
    }




})





  </script>
</body>

</html>